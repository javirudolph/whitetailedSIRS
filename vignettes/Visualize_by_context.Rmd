---
title: "Summarize introduction, spread, prevalence, and persistence"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Summarize introduction, spread, prevalence, and persistence}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(whitetailedSIRS)
library(ggplot2)
library(tidyverse)
library(binom)
```

## Introduction
Now that we have a dataset from our simulations, we can begin to visualize how various characteristics of outbreaks differ between contexts. These figures are used in the published results. Here, we load the dataset and remind R how many iterations were run in each context (nsamples).
```{r}
df <- whitetailedSIRS::example_results
nsamples <- 200
```

## Prevalence and Persistence
```{r, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
ggplot(df, aes(x = Context, y = Infected*100)) +
  geom_boxplot()+
  stat_summary(fun=mean, geom="point", shape="+", size=8) +
  theme_classic()+
  scale_y_continuous("Average prevalence (%)")+
  theme(axis.text = element_text(size = 10), axis.title = element_text(size = 12),legend.text = element_text(size = 12), legend.title = element_text(size = 14), strip.text.x = element_text(size = 14), axis.title.x = element_blank(), axis.text.x = element_text(angle = 90, size = 12)) -> prevalence

#plot persistence
group_by(df, Context) %>% 
  summarize(., Persistence = sum(Persist)) %>% 
  mutate(LCL = binom.confint(Persistence, n = nsamples, methods = "exact")$lower, pred = binom.confint(Persistence, n = nsamples, methods = "exact")$mean ,UCL = binom.confint(Persistence, n = nsamples, methods = "exact")$upper) %>% 
  mutate(Context = factor(Context, levels = c("Outdoor ranch", "Intensive facility", "Wild, rural","Wild, suburban"))) %>% 
  ggplot(., aes(x = Context, y = pred))+
  geom_point()+
  geom_errorbar(aes(ymin = LCL, ymax = UCL))+
  scale_fill_grey()+
  theme_classic()+
  scale_y_continuous("Probability of persistence", limits = c(0,1))+
  theme(axis.text = element_text(size = 10), axis.title = element_text(size = 12),legend.text = element_text(size = 12), legend.title = element_text(size = 14), strip.text.x = element_text(size = 14), axis.title.x = element_blank(), axis.text.x = element_text(angle = 90, size = 12)) -> persistence

ggpubr::ggarrange(prevalence, persistence,nrow =1, ncol=2)
```

## Strength of introduction (FOI) and spread (R0)
```{r, message = F, warning = F, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
#plot r0
ggplot(df, aes(x = Context, y = r0)) +
  geom_boxplot()+
  stat_summary(fun=mean, geom="point", shape="+", size=8) +
  theme_classic()+
  geom_hline(yintercept = 1)+
  scale_y_continuous("Basic reproductive number (r0)", limits = c(0,20))+
  theme(axis.text = element_text(size = 10), axis.title = element_text(size = 12),legend.text = element_text(size = 12), legend.title = element_text(size = 14), strip.text.x = element_text(size = 14), axis.title.x = element_blank(), axis.text.x = element_text(angle = 90, size = 12)) -> r0

#plot FOI
ggplot(df, aes(x = Context, y = log10(FOI))) +
  geom_boxplot()+
  stat_summary(fun.y=mean, geom="point", shape="+", size=8) +
  theme_classic()+
  scale_y_continuous("Spillover hazard from humans (FOI)", limits = c(-8,-2), breaks = c(-6,-5,-4,-3), labels = c("1:10^6","1:10^5", "1:10^4", "1:10^3"))+
  theme(axis.text = element_text(size = 10), axis.title = element_text(size = 12),legend.text = element_text(size = 12), legend.title = element_text(size = 14), strip.text.x = element_text(size = 14), axis.title.x = element_blank(), axis.text.x = element_text(angle = 90, size = 12)) -> FOI

ggpubr::ggarrange(r0, FOI,nrow =1, ncol=2)
```

## Interaction between strengths of introduction and spread, and prevalence and persistence.
```{r, warning=FALSE, message=FALSE, fig.align='center',fig.asp = 0.9, fig.width = 9, out.width="100%"}
#Composite plot showing how R0 and FOI interact to impact prevelence
df %>% 
  mutate(., r0_bin = case_when(r0 <= 1 ~ "Unsustained spread",
                               r0 > 1 & r0 <= 3 ~ "Low spread",
                               r0 > 3 & r0 <= 5 ~ "Medium spread",
                               r0 > 5 ~ "High spread"), 
         r0_bin = factor(r0_bin, levels = c("Unsustained spread","Low spread","Medium spread","High spread"))) %>%
  ggplot(., aes(log10(FOI),Infected*100))+
  geom_point(aes(color = Context))+
  facet_grid(.~r0_bin)+
  scale_color_manual(values = c("black","gray80", "#66A61E","#66D61E"))+
  stat_smooth(method = "glm", method.args = list(family=quasi(link='log')), formula = y~x, color = "black")+
  scale_y_continuous(name = "Average prevalence (%)", limits = c(0,20))+
  theme_classic()+
  theme(strip.text = element_text(size = 12),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 12),axis.text.y = element_text(size = 10), legend.text = element_text(size=10), legend.title = element_text(size=12)) -> Prevalence.plot

df %>% 
  mutate(., r0_bin = case_when(r0 <= 1 ~ "Unsustained spread",
                               r0 > 1 & r0 <= 3 ~ "Low spread",
                               r0 > 3 & r0 <= 5 ~ "Medium spread",
                               r0 > 5 ~ "High spread"), 
         r0_bin = factor(r0_bin, levels = c("Unsustained spread","Low spread","Medium spread","High spread"))) %>%
  ggplot(., aes(log10(FOI),as.numeric(Persist)))+
  geom_point(aes(color = Context))+
  scale_color_manual(values = c("black","gray80", "#66A61E","#66D61E"))+
  facet_grid(.~r0_bin)+
  stat_smooth(method = "glm",method.args = list(family = "binomial"), se = F, color = "gray20")+
  scale_y_continuous(name = "Probability of SARS-CoV-2 persisting", limits = c(0,1), breaks = c(0,0.5,1))+
  scale_x_continuous(name = "Human-to-deer Force-of-Infection (FOI)", breaks = c(-9,-6,-4), labels = c("1:10^9","1:10^6","1:10 000"))+
  theme_classic() +
  theme(axis.title = element_text(size = 12), axis.text = element_text(size = 10), strip.text = element_blank(), legend.text = element_text(size=10), legend.title = element_text(size=12)) ->  Persistence.plot

ggpubr::ggarrange(Prevalence.plot, Persistence.plot, nrow =2, ncol=1, common.legend = T)+
  annotate("label", x = 0.1, y = .8, label = "A", fill = "white", size = 6) +
  annotate("label", x = 0.1, y = .4, label = "B", fill = "white", size = 6)
```

